name: CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Use OCaml 5.1
      uses: ocaml/setup-ocaml@v2
      with:
        ocaml-compiler: 5.1

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libev-dev libsqlite3-dev libgmp-dev pkg-config

    - name: Install dependencies
      run: opam install . --deps-only --with-test

    - name: Build
      run: opam exec -- dune build

    - name: Run tests
      run: opam exec -- dune runtest

  deploy:
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - uses: superfly/flyctl-actions/setup-flyctl@master
    
    - name: Deploy to Fly.io
      run: flyctl deploy --remote-only
      env:
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
